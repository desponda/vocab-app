{{- if and .Values.minio.backup.enabled (not .Values.minio.createFromHelm) }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "vocab-app.fullname" . }}-minio-backup-script
  labels:
    app: minio-backup
data:
  backup.sh: |
    #!/bin/sh
    set -e

    echo "[$(date)] Starting MinIO backup..."

    # Environment variables
    BACKUP_DIR="${BACKUP_DIR:-/backups}"
    BACKUP_RETENTION_DAYS="${BACKUP_RETENTION_DAYS:-30}"
    MINIO_BUCKET="${MINIO_BUCKET:-vocab-documents}"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="${BACKUP_DIR}/minio_${MINIO_BUCKET}_${TIMESTAMP}.tar.gz"
    BACKUP_LOG="${BACKUP_DIR}/backup_${TIMESTAMP}.log"

    # Create backup directory
    mkdir -p "${BACKUP_DIR}"

    echo "[$(date)] Backing up bucket ${MINIO_BUCKET} to ${BACKUP_FILE}..." | tee -a "${BACKUP_LOG}"

    # Use mc (MinIO Client) to mirror bucket to local directory
    mc alias set myminio "${MINIO_ENDPOINT}" "${MINIO_ACCESS_KEY}" "${MINIO_SECRET_KEY}"

    # Create temp directory for backup
    TEMP_DIR="/tmp/minio-backup-${TIMESTAMP}"
    mkdir -p "${TEMP_DIR}"

    # Mirror bucket contents
    echo "[$(date)] Mirroring bucket contents..." | tee -a "${BACKUP_LOG}"
    mc mirror --preserve myminio/${MINIO_BUCKET} "${TEMP_DIR}/" 2>&1 | tee -a "${BACKUP_LOG}"

    # Count files
    FILE_COUNT=$(find "${TEMP_DIR}" -type f | wc -l)
    echo "[$(date)] Mirrored ${FILE_COUNT} files" | tee -a "${BACKUP_LOG}"

    # Create compressed tarball
    echo "[$(date)] Creating compressed archive..." | tee -a "${BACKUP_LOG}"
    tar -czf "${BACKUP_FILE}" -C "${TEMP_DIR}" . 2>&1 | tee -a "${BACKUP_LOG}"

    # Clean up temp directory
    rm -rf "${TEMP_DIR}"

    # Verify backup was created
    if [ ! -f "${BACKUP_FILE}" ]; then
      echo "[$(date)] ERROR: Backup file not created!" | tee -a "${BACKUP_LOG}"
      exit 1
    fi

    # Get backup file size
    BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
    echo "[$(date)] Backup completed: ${BACKUP_FILE} (${BACKUP_SIZE}, ${FILE_COUNT} files)" | tee -a "${BACKUP_LOG}"

    # Clean up old backups
    echo "[$(date)] Cleaning up backups older than ${BACKUP_RETENTION_DAYS} days..." | tee -a "${BACKUP_LOG}"
    find "${BACKUP_DIR}" -name "minio_*.tar.gz" -type f -mtime +${BACKUP_RETENTION_DAYS} -delete
    find "${BACKUP_DIR}" -name "backup_*.log" -type f -mtime +${BACKUP_RETENTION_DAYS} -delete

    # List current backups
    echo "[$(date)] Current backups:" | tee -a "${BACKUP_LOG}"
    ls -lh "${BACKUP_DIR}"/minio_*.tar.gz 2>/dev/null || echo "No backups found"

    echo "[$(date)] Backup process completed" | tee -a "${BACKUP_LOG}"

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "vocab-app.fullname" . }}-minio-backup
  labels:
    app: minio-backup
spec:
  # Schedule: Daily at 3:00 AM UTC (1 hour after database backup)
  schedule: "{{ .Values.minio.backup.schedule }}"

  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid

  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600

      template:
        metadata:
          labels:
            app: minio-backup
        spec:
          restartPolicy: OnFailure

          containers:
          - name: minio-backup
            # Use minio/mc image which includes MinIO client
            image: minio/mc:latest
            command: ["/bin/sh", "/scripts/backup.sh"]

            env:
            - name: MINIO_ENDPOINT
              value: "https://{{ include "vocab-app.fullname" . }}-storage-hl:{{ .Values.minio.port }}"
            - name: MINIO_BUCKET
              value: "{{ .Values.minio.bucket }}"
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.minio.secretName }}
                  key: accessKey
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.minio.secretName }}
                  key: secretKey
            - name: BACKUP_DIR
              value: "/backups"
            - name: BACKUP_RETENTION_DAYS
              value: "{{ .Values.minio.backup.retentionDays }}"
            - name: MC_INSECURE
              value: "true"

            volumeMounts:
            - name: backup-script
              mountPath: /scripts
              readOnly: true
            - name: backup-storage
              mountPath: /backups

            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "500m"

          volumes:
          - name: backup-script
            configMap:
              name: {{ include "vocab-app.fullname" . }}-minio-backup-script
              defaultMode: 0755
          - name: backup-storage
            persistentVolumeClaim:
              claimName: {{ include "vocab-app.fullname" . }}-minio-backup-pvc

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "vocab-app.fullname" . }}-minio-backup-pvc
  labels:
    app: minio-backup
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.minio.backup.storageSize }}
{{- end }}
