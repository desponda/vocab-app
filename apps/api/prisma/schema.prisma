// Prisma schema for Vocab App
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Phase 1: Authentication & User Management
// ============================================================================

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  role          UserRole  @default(STUDENT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  refreshTokens    RefreshToken[]
  students         Student[]
  classrooms       Classroom[]         // Teachers have classrooms
  vocabularySheets VocabularySheet[]  // Teachers upload vocabulary sheets

  @@index([email])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Student {
  id         String   @id @default(cuid())
  name       String
  gradeLevel Int?     // Optional (deprecated - use Classroom.gradeLevel instead)
  userId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments   StudentEnrollment[] // Classroom enrollments
  testAttempts  TestAttempt[]       // Tests taken by student
  studyProgress StudyProgress[]     // Flashcard study progress (privacy: teachers can't see this)

  @@index([userId])
}

// ============================================================================
// Phase 2: Classroom Management & Vocabulary Upload
// ============================================================================

// ===== CLASSROOM MANAGEMENT =====

model Classroom {
  id          String   @id @default(cuid())
  name        String   // e.g., "Grade 3A", "Advanced English"
  code        String   @unique // Unique 6-char code (ABC123)
  gradeLevel  Int      // 1-12 for age-appropriate test difficulty
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teacherId       String
  teacher         User                @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  enrollments     StudentEnrollment[]
  testAssignments TestAssignment[]

  @@index([teacherId])
  @@index([code])
}

model StudentEnrollment {
  id          String   @id @default(cuid())
  enrolledAt  DateTime @default(now())

  studentId   String
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  @@unique([studentId, classroomId])
  @@index([studentId])
  @@index([classroomId])
}

// ===== VOCABULARY & TESTS =====

enum DocumentType {
  PDF
  IMAGE
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum TestType {
  VOCABULARY
  SPELLING
  GENERAL_KNOWLEDGE
}

model VocabularySheet {
  id              String           @id @default(cuid())
  name            String           // User-provided name for vocabulary set
  originalName    String           // Filename for reference
  fileName        String           @unique
  s3Key           String           @unique // MinIO key: {userId}/{fileName}
  processedS3Key  String?          // Compressed/processed image sent to Claude AI
  fileType        DocumentType
  mimeType        String
  fileSize        Int
  gradeLevel      Int?             // Optional: Target grade level (1-12) for test difficulty
  testType        TestType         @default(VOCABULARY) // Type of test to generate
  useAllWords     Boolean          @default(false) // Skip AI extraction, use every line as a word (spelling tests)
  status          ProcessingStatus @default(PENDING)
  errorMessage    String?          @db.Text
  extractedText   String?          @db.Text
  testsToGenerate Int              @default(3) // 3-10
  uploadedAt      DateTime         @default(now())
  processedAt     DateTime?

  teacherId String
  teacher   User             @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  words     VocabularyWord[]
  tests     Test[]

  @@index([teacherId])
  @@index([status])
  @@index([testType])
}

model VocabularyWord {
  id         String    @id @default(cuid())
  word       String
  definition String?   @db.Text
  context    String?   @db.Text
  createdAt  DateTime  @default(now())

  sheetId       String
  sheet         VocabularySheet @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  questions     TestQuestion[]
  studyProgress StudyProgress[] // Student flashcard study progress

  @@index([sheetId])
  @@index([word])
}

model Test {
  id        String   @id @default(cuid())
  name      String   // e.g., "Week 1 Spelling"
  variant   String   // "A", "B", "C"...
  createdAt DateTime @default(now())

  sheetId     String?
  sheet       VocabularySheet?  @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  questions   TestQuestion[]
  assignments TestAssignment[]
  attempts    TestAttempt[]

  @@index([sheetId])
}

enum QuestionType {
  SPELLING
  DEFINITION
  FILL_BLANK
  MULTIPLE_CHOICE
}

model TestQuestion {
  id            String       @id @default(cuid())
  questionText  String       @db.Text
  questionType  QuestionType
  correctAnswer String
  options       String?      @db.Text // JSON for multiple choice
  orderIndex    Int

  testId  String
  test    Test           @relation(fields: [testId], references: [id], onDelete: Cascade)
  wordId  String?
  word    VocabularyWord? @relation(fields: [wordId], references: [id], onDelete: SetNull)
  answers TestAnswer[]

  @@index([testId])
  @@index([wordId])
}

model TestAssignment {
  id         String    @id @default(cuid())
  dueDate    DateTime?
  assignedAt DateTime  @default(now())

  testId      String
  test        Test      @relation(fields: [testId], references: [id], onDelete: Cascade)
  classroomId String
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  @@unique([testId, classroomId])
  @@index([testId])
  @@index([classroomId])
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
  GRADED
}

model TestAttempt {
  id                   String        @id @default(cuid())
  totalQuestions       Int
  correctAnswers       Int?
  score                Int? // 0-100
  status               AttemptStatus @default(IN_PROGRESS)
  startedAt            DateTime      @default(now())
  completedAt          DateTime?
  currentQuestionIndex Int           @default(0) // Track which question student is on
  lastActivityAt       DateTime      @default(now()) // Track last interaction for resume

  testId    String
  test      Test         @relation(fields: [testId], references: [id], onDelete: Cascade)
  studentId String
  student   Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  answers   TestAnswer[]

  @@index([testId])
  @@index([studentId])
  @@index([status])
}

model TestAnswer {
  id         String    @id @default(cuid())
  answer     String
  isCorrect  Boolean?
  wasSkipped Boolean   @default(false) // Track if student skipped this question
  answeredAt DateTime  @default(now())

  attemptId  String
  attempt    TestAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId String
  question   TestQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
}

// ============================================================================
// Phase 8: Study Mode - Flashcard Study Progress
// ============================================================================

model StudyProgress {
  id            String    @id @default(cuid())
  confidence    Int       @default(0) // 0 = not seen, 1 = "Not Yet", 2 = "Got It!"
  lastStudiedAt DateTime?
  studyCount    Int       @default(0) // How many times reviewed
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  studentId String
  student   Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  wordId    String
  word      VocabularyWord @relation(fields: [wordId], references: [id], onDelete: Cascade)

  @@unique([studentId, wordId])
  @@index([studentId])
  @@index([wordId])
  @@index([confidence])
}
