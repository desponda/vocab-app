---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "vocab-app.fullname" . }}-minio-config-generator
  labels:
    app: minio-config-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "vocab-app.fullname" . }}-minio-config-generator
  labels:
    app: minio-config-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "vocab-app.fullname" . }}-minio-config-generator
  labels:
    app: minio-config-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "vocab-app.fullname" . }}-minio-config-generator
subjects:
- kind: ServiceAccount
  name: {{ include "vocab-app.fullname" . }}-minio-config-generator
  namespace: {{ .Release.Namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "vocab-app.fullname" . }}-minio-config-generator-{{ .Release.Revision }}
  labels:
    app: minio-config-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: minio-config-generator
    spec:
      serviceAccountName: {{ include "vocab-app.fullname" . }}-minio-config-generator
      restartPolicy: Never
      containers:
      - name: minio-config-generator
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e

          CONFIG_SECRET_NAME="{{ include "vocab-app.fullname" . }}-minio-config"
          MINIO_SECRET_NAME="{{ .Values.minio.secretName }}"
          NAMESPACE="{{ .Release.Namespace }}"

          echo "Waiting for MinIO credentials secret to be created..."
          for i in {1..30}; do
            if kubectl get secret "$MINIO_SECRET_NAME" -n "$NAMESPACE" &>/dev/null; then
              echo "✓ MinIO secret found"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "✗ Timeout waiting for MinIO secret"
              exit 1
            fi
            echo "  Attempt $i/30 - waiting..."
            sleep 2
          done

          echo "Extracting credentials from MinIO secret..."

          # Get the credentials from the MinIO secret
          MINIO_ROOT_USER=$(kubectl get secret "$MINIO_SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.accessKey}' | base64 -d)
          MINIO_ROOT_PASSWORD=$(kubectl get secret "$MINIO_SECRET_NAME" -n "$NAMESPACE" -o jsonpath='{.data.secretKey}' | base64 -d)

          if [ -z "$MINIO_ROOT_USER" ] || [ -z "$MINIO_ROOT_PASSWORD" ]; then
            echo "✗ Failed to extract credentials from MinIO secret"
            exit 1
          fi

          echo "Creating MinIO configuration secret..."

          # Create the config secret for MinIO Operator v6.0.0
          # MinIO Operator v6.0.0 requires spec.configuration.name pointing to a secret with config.env key
          kubectl create secret generic "$CONFIG_SECRET_NAME" \
            -n "$NAMESPACE" \
            --from-literal=config.env="export MINIO_ROOT_USER=$MINIO_ROOT_USER
export MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD" \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "✓ MinIO configuration secret created/updated successfully"
          echo "  Secret name: $CONFIG_SECRET_NAME"
          echo "  Namespace: $NAMESPACE"
