{{- if not .Values.secrets.createFromHelm }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "vocab-app.fullname" . }}-secret-generator
  labels:
    app: secret-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "vocab-app.fullname" . }}-secret-generator
  labels:
    app: secret-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "vocab-app.fullname" . }}-secret-generator
  labels:
    app: secret-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "vocab-app.fullname" . }}-secret-generator
subjects:
- kind: ServiceAccount
  name: {{ include "vocab-app.fullname" . }}-secret-generator
  namespace: {{ .Release.Namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "vocab-app.fullname" . }}-secret-generator-{{ .Release.Revision }}
  labels:
    app: secret-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: secret-generator
    spec:
      serviceAccountName: {{ include "vocab-app.fullname" . }}-secret-generator
      restartPolicy: Never
      containers:
      - name: secret-generator
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e

          SECRET_NAME="{{ .Values.secrets.externalSecretName }}"
          NAMESPACE="{{ .Release.Namespace }}"

          echo "Checking if secret '$SECRET_NAME' exists in namespace '$NAMESPACE'..."

          if kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" &>/dev/null; then
            echo "✓ Secret '$SECRET_NAME' already exists. Skipping creation."
            echo "  (Secrets are persistent across deployments)"
            exit 0
          fi

          echo "Secret not found. Generating secure random secrets..."

          # Generate secure random secrets (base64 encoded, 32+ chars)
          JWT_ACCESS_SECRET=$(openssl rand -base64 32 | tr -d '\n')
          JWT_REFRESH_SECRET=$(openssl rand -base64 32 | tr -d '\n')
          POSTGRES_PASSWORD=$(openssl rand -base64 24 | tr -d '\n')

          # Construct database URL
          DATABASE_URL="postgresql://postgres:${POSTGRES_PASSWORD}@{{ include "vocab-app.fullname" . }}-postgres:{{ .Values.postgres.service.port }}/{{ (index .Values.postgres.env 0).value }}"

          echo "Creating secret '$SECRET_NAME'..."

          kubectl create secret generic "$SECRET_NAME" \
            --namespace="$NAMESPACE" \
            --from-literal=postgres-password="$POSTGRES_PASSWORD" \
            --from-literal=database-url="$DATABASE_URL" \
            --from-literal=jwt-access-secret="$JWT_ACCESS_SECRET" \
            --from-literal=jwt-refresh-secret="$JWT_REFRESH_SECRET"

          echo "✓ Secret '$SECRET_NAME' created successfully"
          echo "  JWT Access Secret: ${#JWT_ACCESS_SECRET} characters"
          echo "  JWT Refresh Secret: ${#JWT_REFRESH_SECRET} characters"
          echo "  Postgres Password: ${#POSTGRES_PASSWORD} characters"
          echo ""
          echo "Note: These secrets will persist across Helm upgrades."
          echo "To rotate secrets, delete the secret and upgrade again:"
          echo "  kubectl delete secret $SECRET_NAME -n $NAMESPACE"
          echo "  helm upgrade {{ .Release.Name }} ."
{{- end }}
