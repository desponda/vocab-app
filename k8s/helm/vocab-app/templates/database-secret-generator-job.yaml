{{- if not .Values.secrets.database.createFromHelm }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "vocab-app.fullname" . }}-database-secret-generator
  labels:
    app: database-secret-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "vocab-app.fullname" . }}-database-secret-generator
  labels:
    app: database-secret-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "vocab-app.fullname" . }}-database-secret-generator
  labels:
    app: database-secret-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "vocab-app.fullname" . }}-database-secret-generator
subjects:
- kind: ServiceAccount
  name: {{ include "vocab-app.fullname" . }}-database-secret-generator
  namespace: {{ .Release.Namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "vocab-app.fullname" . }}-database-secret-generator-{{ .Release.Revision }}
  labels:
    app: database-secret-generator
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: database-secret-generator
    spec:
      serviceAccountName: {{ include "vocab-app.fullname" . }}-database-secret-generator
      restartPolicy: Never
      containers:
      - name: database-secret-generator
        image: bitnami/kubectl:1.31
        command:
        - /bin/bash
        - -c
        - |
          set -e

          SECRET_NAME="{{ .Values.secrets.database.secretName }}"
          NAMESPACE="{{ .Release.Namespace }}"

          echo "Checking if database secret '$SECRET_NAME' exists in namespace '$NAMESPACE'..."

          if kubectl get secret "$SECRET_NAME" -n "$NAMESPACE" &>/dev/null; then
            echo "✓ Secret '$SECRET_NAME' already exists. Skipping creation."
            echo "  (Secrets are persistent across deployments)"
            exit 0
          fi

          echo "Secret not found. Generating secure random database credentials..."

          # Generate secure random password (base64 encoded, 24+ chars)
          POSTGRES_PASSWORD=$(openssl rand -base64 24 | tr -d '\n')

          # URL-encode the password for safe embedding in connection string
          # Base64 can contain /, +, = which break URL parsing
          POSTGRES_PASSWORD_ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$POSTGRES_PASSWORD', safe=''))")

          # Construct database URL with URL-encoded password
          DATABASE_URL="postgresql://postgres:${POSTGRES_PASSWORD_ENCODED}@{{ include "vocab-app.fullname" . }}-postgres:{{ .Values.postgres.service.port }}/{{ (index .Values.postgres.env 0).value }}"

          echo "Creating database secret '$SECRET_NAME'..."

          # Note: postgres-password stores the RAW password (for POSTGRES_PASSWORD env var)
          # database-url contains the URL-ENCODED password (for Prisma connection string)
          kubectl create secret generic "$SECRET_NAME" \
            --namespace="$NAMESPACE" \
            --from-literal=postgres-password="$POSTGRES_PASSWORD" \
            --from-literal=database-url="$DATABASE_URL"

          echo "✓ Database secret '$SECRET_NAME' created successfully"
          echo "  Postgres Password: ${#POSTGRES_PASSWORD} characters"
          echo ""
          echo "Note: This secret will persist across Helm upgrades."
          echo "To rotate secrets, delete the secret and upgrade again:"
          echo "  kubectl delete secret $SECRET_NAME -n $NAMESPACE"
          echo "  helm upgrade {{ .Release.Name }} ."
{{- end }}
