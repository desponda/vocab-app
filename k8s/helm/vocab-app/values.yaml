global:
  domain: vocab-staging.dresponda.com
  environment: staging

api:
  replicaCount: 2
  image:
    repository: ghcr.io/desponda/vocab-app-api
    tag: sha-4e653b6
    pullPolicy: Always
  service:
    type: ClusterIP
    port: 3001
  env:
    - name: NODE_ENV
      value: "production"
    - name: PORT
      value: "3001"
    - name: HOST
      value: "0.0.0.0"
    - name: CORS_ORIGIN
      value: "https://vocab-staging.dresponda.com"
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "1000m"
  podDisruptionBudget:
    enabled: true
    minAvailable: 1  # Ensure at least 1 pod available during rollouts

web:
  replicaCount: 2
  image:
    repository: ghcr.io/desponda/vocab-app-web
    tag: sha-5c16439
    pullPolicy: Always
  service:
    type: ClusterIP
    port: 3000
  env:
    - name: NODE_ENV
      value: "production"
    - name: NEXT_PUBLIC_API_URL
      value: "https://vocab-staging.dresponda.com/api"
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  podDisruptionBudget:
    enabled: true
    minAvailable: 1  # Ensure at least 1 pod available during rollouts

postgres:
  enabled: true
  image: postgres:16-alpine
  service:
    port: 5432
  storage:
    # 5Gi is plenty for ~1,000 users with room to grow
    size: 5Gi
  env:
    - name: POSTGRES_DB
      value: "vocab_app_staging"
    - name: POSTGRES_USER
      value: "postgres"
  backup:
    enabled: true
    # Schedule in cron format (daily at 2:00 AM UTC)
    schedule: "0 2 * * *"
    # Keep backups for 30 days
    retentionDays: 30
    # Storage size for backup PVC (2x database size for 30 days of daily backups)
    storageSize: 10Gi

redis:
  enabled: true
  image: redis:7-alpine
  service:
    port: 6379
  storage:
    size: 2Gi

minio:
  # MinIO credentials are auto-generated by secret-generator-job
  # Secret is created automatically with random accessKey and secretKey
  createFromHelm: false
  secretName: "vocab-app-minio-secret"

  # MinIO endpoint configuration
  # MinIO Tenant CRD is deployed as part of this Helm chart (templates/minio-tenant.yaml)
  # Requires MinIO Operator to be installed in the cluster
  # Service name: {release-name}-storage-hl.{namespace}.svc.cluster.local
  # Example: vocab-app-staging-storage-hl.vocab-app-staging.svc.cluster.local
  port: 9000
  useSSL: true
  bucket: "vocab-documents"

  backup:
    enabled: true
    # Schedule in cron format (daily at 3:00 AM UTC, 1 hour after database backup)
    schedule: "0 3 * * *"
    # Keep backups for 30 days
    retentionDays: 30
    # Storage size for backup PVC (~1-2x expected bucket size for ~1,000 users)
    # Estimated: 5-10GB for 1,000 users with 5 files each
    storageSize: 15Gi

ingress:
  enabled: true
  className: cloudflare-tunnel
  host: vocab-staging.dresponda.com
  annotations:
    cert-manager.io/cluster-issuer: "cloudflare"

# Network Policies (restrict pod-to-pod communication)
networkPolicy:
  enabled: false  # Disabled by default, enable when cluster supports NetworkPolicy
  # Note: Requires a CNI plugin that supports NetworkPolicy (e.g., Calico, Cilium, Weave Net)

# Secrets Management:
# IMPORTANT: Secrets are NOT stored in this file (which is checked into git)
# Instead, use automated secret generators or create secrets manually
# Or override with: helm install --set-file secrets.database.postgresPassword=./postgres-password.txt

secrets:
  # Separated secrets configuration
  # Each secret is created automatically by its generator job (idempotent)
  # Provides independent rotation schedules and principle of least privilege

  # Secret Rotation Configuration
  # Recommended rotation intervals (customize based on compliance requirements)
  rotation:
    # Rotation schedule in days (set to 0 to disable automated reminders)
    database:
      intervalDays: 90  # Rotate database password every 90 days
      lastRotated: ""   # Track last rotation date (YYYY-MM-DD)
    jwt:
      intervalDays: 90  # Rotate JWT secrets every 90 days (logs out all users)
      lastRotated: ""   # Track last rotation date (YYYY-MM-DD)
    minio:
      intervalDays: 90  # Rotate MinIO credentials every 90 days
      lastRotated: ""   # Track last rotation date (YYYY-MM-DD)
    # Note: Anthropic API key rotation is manual only (when key is regenerated in console)

  database:
    # Secret containing postgres-password and database-url
    secretName: "vocab-app-database-secret"
    createFromHelm: false
    # Only used if createFromHelm=true (local dev only)
    postgresPassword: ""

  jwt:
    # Secret containing jwt-access-secret and jwt-refresh-secret
    secretName: "vocab-app-jwt-secret"
    createFromHelm: false
    # Only used if createFromHelm=true (local dev only)
    # Must meet validation: JWT secrets >= 32 chars
    accessSecret: ""
    refreshSecret: ""

  anthropic:
    # Secret containing anthropic-api-key (optional)
    secretName: "vocab-app-anthropic-secret"
    createFromHelm: false
    # Only used if createFromHelm=true (local dev only)
    apiKey: ""
